name: ブランチ作成とforce push

on:
  push:
    branches:
      - main

jobs:
  create-branch-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト(全ブランチ)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: data.csvの作成
        run: |
          echo "a,b,c" > data.csv
      - name: move data.csv tmp/data.csv
        run: |
          echo '---'
          echo "$(git branch)"
          echo '---[ ls -alh ]'
          ls -alh
          echo '---[ ls -alh tmp/ ]'
          ls -alh tmp/
          echo '---'
          mv data.csv tmp/data.csv
          echo '---'
          echo "$(git branch)"
          echo '---[ ls -alh tmp/ ]'
          ls -alh tmp/
          echo '---'
      - name: ブランチへswitch
        run: |
          echo '---[ switch 前 ls -lah ]'
          ls -lah
          branch_name="storage"
          git switch ${branch_name} || git switch -c ${branch_name}
          echo '---[ switch 後 ls -lah ]'
          ls -lah
      - name: git commit
        run: |
          echo '---'
          echo "$(git branch)"
          echo '---[ ls -alh tmp/ ]'
          ls -alh tmp/
          echo '---'
          mv tmp/data.csv ./
          git stage .
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit --amend -m "Automated commit"
      - name: ブランチへforce push
        run: |
          branch_name="storage"
          echo '---'
          echo "BRANCH: ${branch_name}"
          echo '---'
          git push origin $branch_name --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
