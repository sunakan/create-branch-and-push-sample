name: ブランチ作成とforce push

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  create-branch-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: リポジトリをチェックアウト(全ブランチ)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: storageブランチからdata.csvを引っ張る
        run: |
          branch_name="storage"
          git switch ${branch_name} || git switch -c ${branch_name}
          mkdir -p tmp
          mv data.csv tmp/
          git switch -
          mv tmp/data.csv ./
      - name: data.csvの作成
        run: |
          echo "a,b,c,$(date)" >> data.csv
          cat data.csv | tail -n 3 > tmp/data.csv
          rm data.csv
      - name: ブランチへswitch
        run: |
          branch_name="storage"
          git switch ${branch_name} || git switch -c ${branch_name}
      - name: git commit
        run: |
          mv tmp/data.csv ./
          git stage .
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit --amend -m "Automated commit"
      - name: ブランチへforce push
        run: |
          branch_name="storage"
          git push origin $branch_name --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
